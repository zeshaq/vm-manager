{% extends 'base.html' %}

{% block content %}
<div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">

    <!-- Page Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
        <div>
            <h1>Load Balancer Routes</h1>
            <p style="color: #666; margin: 0;">Map public hostnames to your running VMs.</p>
        </div>
        {% if setup_complete %}
        <a href="{{ url_for('loadbalancer.stats_proxy') }}">
            <button style="background: #6c757d;">View HAProxy Stats</button>
        </a>
        {% endif %}
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div style="padding: 15px; margin-bottom: 20px; border-radius: 4px; color: #fff; background-color: {{ '#28a745' if category == 'success' else '#dc3545' }};">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if not setup_complete %}
    <div style="padding: 15px; margin-bottom: 20px; border-radius: 4px; color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba;">
        <strong>Setup Incomplete:</strong> The load balancer requires setup before you can add routes.
        <a href="{{ url_for('setup.setup_page') }}" style="font-weight: bold; color: #856404;">Go to Setup</a>
    </div>
    {% endif %}

    <!-- Create New Route Form -->
    <div style="background:#f1f1f1; padding: 20px; margin-bottom:30px; border-radius: 8px;">
        <h3 style="margin-top: 0;">Add New Route</h3>
        <form action="{{ url_for('loadbalancer.add_route') }}" method="POST" style="display: grid; grid-template-columns: 1fr 1fr 80px 100px; gap: 15px; align-items: center;">
            
            <input type="text" name="frontend_host" placeholder="app.example.com" required style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;" {% if not setup_complete %}disabled{% endif %}>
            
            <select name="vm_selection" required style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: white;" {% if not setup_complete %}disabled{% endif %}>
                <option value="" disabled selected>-- Select a Running VM --</option>
                {% for vm in vms %}
                    <option value="{{ vm.uuid }}|{{ vm.name }}">{{ vm.name }}</option>
                {% endfor %}
            </select>
            
            <input type="number" name="backend_port" placeholder="Port" min="1" max="65535" required style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;" {% if not setup_complete %}disabled{% endif %}>
            
            <button type="submit" style="background:#28a745; color:white; border:none; padding: 8px 12px; border-radius:4px; cursor:pointer;" {% if not setup_complete %}disabled{% endif %}>+ Add</button>
        </form>
    </div>

    <!-- Existing Routes Table -->
    <h3 style="color: #444;">Configured Routes</h3>
    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
        <thead style="background: #f8f9fa;">
            <tr>
                <th style="padding: 10px; border-bottom: 2px solid #ddd; text-align: left;">Frontend Host</th>
                <th style="padding: 10px; border-bottom: 2px solid #ddd; text-align: left;">Backend VM</th>
                <th style="padding: 10px; border-bottom: 2px solid #ddd; text-align: left;">Backend Port</th>
                <th style="padding: 10px; border-bottom: 2px solid #ddd; text-align: right;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for route in routes %}
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;"><strong>http://{{ route.frontend_host }}</strong></td>
                <td style="padding: 10px;">{{ route.vm_name }}</td>
                <td style="padding: 10px;">{{ route.backend_port }}</td>
                <td style="padding: 10px; text-align: right;">
                    <form action="{{ url_for('loadbalancer.delete_route') }}" method="POST" style="display:inline;">
                        <input type="hidden" name="frontend_host" value="{{ route.frontend_host }}">
                        <button type="submit" onclick="return confirm('Delete this route?')" 
                                style="background:transparent; color:#dc3545; border:1px solid #dc3545; padding:4px 8px; border-radius:4px; font-size:0.8em; cursor:pointer;">
                            Delete
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px; color: #777;">No routes configured yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background: #fffbe6; border: 1px solid #ffeeba; border-radius: 4px; font-size: 0.9em;">
        <strong>Note:</strong> For the frontend hostnames to work, you must either have a DNS server that resolves them to this host's IP, or add them to the <code>/etc/hosts</code> file on the computer you are browsing from.
    </div>

</div>
{% endblock %}