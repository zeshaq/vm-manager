{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-body">
        <a href="{{ url_for('listing.view_vm', uuid=vm.uuid) }}" class="text-decoration-none text-muted">‚Üê Back to {{ vm.name }}</a>
        <h1 class="mt-2">Live Monitoring: {{ vm.name }}</h1>
        
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">CPU Usage (%)</h5>
                        <canvas id="cpuChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Memory Usage (MB)</h5>
                        <canvas id="memChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Disk I/O (Bytes/s)</h5>
                        <canvas id="diskChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Network I/O (Bytes/s)</h5>
                        <canvas id="netChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
    const MAX_DATA_POINTS = 20;

    function createRealTimeChart(elementId, title) {
        const ctx = document.getElementById(elementId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: title,
                    data: [],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    fill: true,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.2
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'second',
                            displayFormats: {
                                second: 'HH:mm:ss'
                            }
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    const cpuChart = createRealTimeChart('cpuChart', 'CPU Usage (%)');
    const memChart = createRealTimeChart('memChart', 'Memory Usage (MB)');
    const diskChart = createRealTimeChart('diskChart', 'Disk I/O (Bytes/s)');
    const netChart = createRealTimeChart('netChart', 'Network I/O (Bytes/s)');
    
    diskChart.data.datasets = [
        { label: 'Read', data: [], borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 2, fill: true, backgroundColor: 'rgba(255, 99, 132, 0.2)', tension: 0.2 },
        { label: 'Write', data: [], borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 2, fill: true, backgroundColor: 'rgba(54, 162, 235, 0.2)', tension: 0.2 }
    ];
    diskChart.options.plugins.legend.display = true;

    netChart.data.datasets = [
        { label: 'Received', data: [], borderColor: 'rgba(255, 206, 86, 1)', borderWidth: 2, fill: true, backgroundColor: 'rgba(255, 206, 86, 0.2)', tension: 0.2 },
        { label: 'Transmitted', data: [], borderColor: 'rgba(153, 102, 255, 1)', borderWidth: 2, fill: true, backgroundColor: 'rgba(153, 102, 255, 0.2)', tension: 0.2 }
    ];
    netChart.options.plugins.legend.display = true;

    function addData(chart, label, data) {
        chart.data.labels.push(label);
        if (Array.isArray(data)) {
            data.forEach((d, i) => chart.data.datasets[i].data.push(d));
        } else {
            chart.data.datasets[0].data.push(data);
        }

        if (chart.data.labels.length > MAX_DATA_POINTS) {
            chart.data.labels.shift();
            chart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        chart.update('quiet');
    }

    async function updateCharts() {
        try {
            const response = await fetch(`/api/stats/{{ vm.uuid }}`);
            const data = await response.json();
            const now = new Date();

            if (data.error) {
                console.error(data.error);
                return;
            }

            addData(cpuChart, now, data.cpu_usage);
            addData(memChart, now, data.mem_used);
            addData(diskChart, now, [data.disk_read, data.disk_write]);
            addData(netChart, now, [data.net_rx, data.net_tx]);

        } catch (error) {
            console.error('Error fetching VM stats:', error);
        }
    }

    setInterval(updateCharts, 2000);
</script>
{% endblock %}
