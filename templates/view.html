{% extends 'base.html' %}

{% block content %}
<div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    
    <!-- HEADER -->
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px;">
        <div>
            <a href="/list" style="text-decoration: none; color: #666;">← Back to List</a>
            <h1 style="margin: 10px 0 5px 0;">{{ vm.name }}</h1>
            <span style="background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; color: #555;">{{ vm.uuid }}</span>
        </div>
        
        <div>
            {% if vm.state_code == 1 %}
                <span style="background: #d4edda; color: #155724; padding: 10px 20px; border-radius: 20px; font-weight: bold;">Running</span>
            {% else %}
                <span style="background: #f8d7da; color: #721c24; padding: 10px 20px; border-radius: 20px; font-weight: bold;">{{ vm.state }}</span>
            {% endif %}
        </div>
    </div>

    <!-- SPECS & BOOT GRID -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
        <!-- Resources -->
        <div>
            <h3 style="color: #444;">Resources</h3>
            <table style="width: 100%; border: none;">
                <tr><td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>vCPUs:</strong></td><td style="border-bottom: 1px solid #eee;">{{ vm.vcpus }}</td></tr>
                <tr><td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>Memory:</strong></td><td style="border-bottom: 1px solid #eee;">{{ vm.memory_mb }} MB</td></tr>
            </table>
        </div>
        
        <!-- Boot Config -->
        <div>
            <h3 style="color: #444;">Boot Configuration</h3>
            
            <!-- NEW: Current Boot Order Display Block -->
            <div style="background: #f1f8ff; border: 1px solid #cce5ff; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                <strong style="color: #004085; display: block; margin-bottom: 5px; font-size: 0.9em;">CURRENT BOOT PRIORITY:</strong>
                <ol style="margin: 0; padding-left: 20px; font-size: 0.95em; color: #333;">
                    <!-- 1st Device -->
                    <li style="margin-bottom: 2px;">
                        {% if vm.current_boot['1'] == 'network' %} Network (PXE)
                        {% elif vm.current_boot['1'] and 'disk|' in vm.current_boot['1'] %} Disk ({{ vm.current_boot['1'].split('|')[1] }})
                        {% elif vm.current_boot['1'] == 'hd_generic' %} Hard Disk (Generic)
                        {% elif vm.current_boot['1'] == 'cdrom_generic' %} CD-ROM (Generic)
                        {% else %} Not Set {% endif %}
                    </li>
                    <!-- 2nd Device -->
                    <li>
                        {% if vm.current_boot['2'] == 'network' %} Network (PXE)
                        {% elif vm.current_boot['2'] and 'disk|' in vm.current_boot['2'] %} Disk ({{ vm.current_boot['2'].split('|')[1] }})
                        {% elif vm.current_boot['2'] == 'hd_generic' %} Hard Disk (Generic)
                        {% elif vm.current_boot['2'] == 'cdrom_generic' %} CD-ROM (Generic)
                        {% else %} <em>None</em> {% endif %}
                    </li>
                </ol>
            </div>

            <!-- Edit Form -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 4px; border: 1px solid #eee;">
                <form action="{{ url_for('listing.update_boot_order', uuid=vm.uuid) }}" method="POST">
                    
                    <!-- Boot 1 -->
                    <div style="margin-bottom: 10px;">
                        <label style="font-size:0.9em; font-weight:bold;">1st Boot Device:</label>
                        <select name="boot1" style="padding: 5px; width: 100%;">
                            <option value="network" {% if vm.current_boot['1'] == 'network' %}selected{% endif %}>Network (PXE)</option>
                            <option disabled>--- Disks ---</option>
                            {% for disk in vm.disks %}
                                {% set val = 'disk|' + disk.target %}
                                <option value="{{ val }}" {% if vm.current_boot['1'] == val %}selected{% endif %}>
                                    {{ disk.device|upper }} ({{ disk.target }}) - {{ disk.file.split('/')[-1] }}
                                </option>
                            {% endfor %}
                            <option disabled>--- Legacy ---</option>
                            <option value="hd_generic" {% if vm.current_boot['1'] == 'hd_generic' %}selected{% endif %}>Any Hard Disk</option>
                            <option value="cdrom_generic" {% if vm.current_boot['1'] == 'cdrom_generic' %}selected{% endif %}>Any CD-ROM</option>
                        </select>
                    </div>

                    <!-- Boot 2 -->
                    <div style="margin-bottom: 10px;">
                        <label style="font-size:0.9em; font-weight:bold;">2nd Boot Device:</label>
                        <select name="boot2" style="padding: 5px; width: 100%;">
                            <option value="none">None</option>
                            <option value="network" {% if vm.current_boot['2'] == 'network' %}selected{% endif %}>Network (PXE)</option>
                            <option disabled>--- Disks ---</option>
                            {% for disk in vm.disks %}
                                {% set val = 'disk|' + disk.target %}
                                <option value="{{ val }}" {% if vm.current_boot['2'] == val %}selected{% endif %}>
                                    {{ disk.device|upper }} ({{ disk.target }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" style="background: #007bff; color:white; border:none; padding: 6px 12px; border-radius:4px; font-size:0.9em; cursor:pointer;">Save Boot Order</button>
                    <div style="font-size:0.8em; color:#888; margin-top:5px;">* Applies on next restart</div>
                </form>
            </div>
        </div>
    </div>

    <!-- STORAGE SECTION -->
    <div style="margin-bottom: 30px;">
        <h3 style="color: #444;">Storage Devices</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em; border: 1px solid #eee;">
            <thead style="background: #f8f9fa;">
                <tr>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">Device</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">Source</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">Type</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:right;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for disk in vm.disks %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;"><strong>{{ disk.target }}</strong></td>
                    <td style="padding: 10px; word-break:break-all;">{{ disk.file }}</td>
                    <td style="padding: 10px;">{{ disk.device }}</td>
                    <td style="padding: 10px; text-align: right;">
                        <form action="{{ url_for('listing.delete_disk', uuid=vm.uuid) }}" method="POST" style="display:inline;">
                            <input type="hidden" name="target_dev" value="{{ disk.target }}">
                            <button type="submit" onclick="return confirm('Detach this disk?')" style="background:transparent; color:#dc3545; border:1px solid #dc3545; padding:4px 8px; border-radius:4px; font-size:0.8em; cursor:pointer;">Detach</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <form action="{{ url_for('listing.add_disk', uuid=vm.uuid) }}" method="POST" style="background:#f1f1f1; padding:15px; margin-top:15px; border-radius:5px; display:flex; align-items:center; gap:10px;">
            <strong style="color:#555; font-size:0.9em;">Attach:</strong>
            <input type="text" name="file_path" placeholder="/var/lib/libvirt/images/disk.qcow2" required style="padding:6px; border:1px solid #ccc; border-radius:4px; flex-grow:1;">
            <input type="text" name="target_dev" placeholder="vdb" required style="padding:6px; border:1px solid #ccc; border-radius:4px; width:80px;">
            <button type="submit" style="background:#28a745; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">+ Add</button>
        </form>
    </div>

    <!-- NETWORK SECTION -->
    <div style="margin-bottom: 30px;">
        <h3 style="color: #444;">Network Interfaces</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em; border: 1px solid #eee;">
            <thead style="background: #f8f9fa;">
                <tr>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">Model</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">Type/Source</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">MAC</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:left;">IP</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd; text-align:right;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% if vm.interfaces %}
                    {% for iface in vm.interfaces %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">{{ iface.model }}</td>
                        <td style="padding: 10px;">
                            <strong style="text-transform: capitalize;">{{ iface.type }}</strong>
                            <span style="color:#666">→ {{ iface.network }}</span>
                        </td>
                        <td style="padding: 10px; font-family:monospace;">{{ iface.mac }}</td>
                        <td style="padding: 10px;">{% for ip in iface.ips %}{{ ip }}<br>{% endfor %}</td>
                        <td style="padding: 10px; text-align: right;">
                            <form action="{{ url_for('listing.delete_interface', uuid=vm.uuid) }}" method="POST" style="display:inline;">
                                <input type="hidden" name="mac" value="{{ iface.mac }}">
                                <button type="submit" onclick="return confirm('Remove interface?')" style="background:transparent; color:#dc3545; border:1px solid #dc3545; padding:4px 8px; border-radius:4px; font-size:0.8em; cursor:pointer;">Remove</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="5" style="text-align:center; padding:15px; color:#777;">No interfaces found</td></tr>
                {% endif %}
            </tbody>
        </table>
        
        <!-- ADD INTERFACE FORM -->
        <form action="{{ url_for('listing.add_interface', uuid=vm.uuid) }}" method="POST" style="background:#f1f1f1; padding:15px; margin-top:15px; border-radius:5px; display:flex; align-items:center; gap:10px;">
            <strong style="color:#555; font-size:0.9em;">Add Net:</strong>
            
            <select name="mode" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 140px; background:white;">
                <option value="network">Virtual Network</option>
                <option value="bridge">Host Bridge</option>
            </select>
            
            <input type="text" name="source" placeholder="Name (e.g. default, br0)" value="default" required style="padding:6px; border:1px solid #ccc; border-radius:4px; flex-grow: 1;">
            
            <button type="submit" style="background:#28a745; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">+ Attach</button>
        </form>
    </div>

    <!-- ACTIONS FOOTER -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
        <h3 style="margin-top: 0;">Actions</h3>
        {% if vm.state_code == 1 %}
            <a href="{{ url_for('listing.console_vm', uuid=vm.uuid) }}"><button style="background: #343a40; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">Open Console</button></a>
            <a href="{{ url_for('listing.stop_vm', uuid=vm.uuid) }}" onclick="return confirm('Force Stop?');"><button style="background: #dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">Stop VM</button></a>
        {% else %}
            <a href="{{ url_for('listing.start_vm', uuid=vm.uuid) }}"><button style="background: #28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">Start VM</button></a>
        {% endif %}
        
        <a href="{{ url_for('listing.delete_vm', uuid=vm.uuid) }}" onclick="return confirm('Delete permanently?');" style="float: right;">
            <button style="background: #6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">Delete VM</button>
        </a>
        <a href="{{ url_for('listing.edit_vm', uuid=vm.uuid) }}">
            <button style="background: #ffc107; color: #212529; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-right: 10px;">Edit Resources</button>
        </a>
    </div>

</div>
{% endblock %}